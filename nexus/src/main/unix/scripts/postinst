#! /bin/sh
# postinst script for nexus
#
# see: dh_installdeb(1)

#set -e

create_missing_links() {
  if [ ! -d /var/lib/nexus ]; then
    mkdir /var/lib/nexus
  fi

  if [ ! -d /etc/nexus ]; then
    mkdir /etc/nexus
    mkdir /etc/nexus/jsw
  fi

  ln -sf /usr/lib/nexus/conf/plexus.xml /etc/nexus/plexus.xml
  ln -sf /usr/lib/nexus/conf/plexus.properties /etc/nexus/plexus.properties
  ln -sf /usr/lib/nexus/conf/classworlds.conf /etc/nexus/classworlds.conf
  ln -sf /usr/lib/nexus/conf/jetty.xml /etc/nexus/jetty.xml

  if [ ! -d /etc/nexus/jsw ]; then
    mkdir /etc/nexus/jsw
  fi
  
  ln -sf /usr/lib/nexus/bin/jsw/conf/wrapper.conf /etc/nexus/jsw/wrapper.conf
}

set_access_rights() {
  chmod 0755 /etc/init.d/nexus
  chmod 0755 /usr/lib/nexus/bin/jsw/linux-x86-64/wrapper
  chmod 0600 /etc/default/nexus
  chown -R nexus:nexus /usr/lib/nexus
  chown -R nexus:nexus /var/log/nexus
  chown -R nexus:nexus /var/lib/nexus
  return 0
}

patch_nexus() {
  NEXUS_HOME=/usr/lib/nexus
  sed -i 's/\(nexus-work=\)\(.*\)/\1\/var\/lib\/nexus/g' $NEXUS_HOME/conf/plexus.properties
  sed -i 's/\(webapp-context-path=\)\(.*\)/\1\//g' $NEXUS_HOME/conf/plexus.properties
  sed -i 's/\(wrapper.logfile=\)\(.*\)/\1\/var\/log\/nexus\/wrapper.log/g' $NEXUS_HOME/bin/jsw/conf/wrapper.conf
}

case "$1" in

    install|upgrade)
    ;;

    abort-upgrade)
    ;;

    configure)
       create_missing_links
       patch_nexus
       set_access_rights
       update-rc.d nexus defaults
    ;;

    *)
        echo "preinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0

